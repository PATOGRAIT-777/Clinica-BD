<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mis mascotas — TechSide</title>
  <link rel="stylesheet" href="../css/universalCss.css" type="text/css">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="/">Clinica</a>
      <nav class="main-nav" aria-label="Navegación principal">
        <a  href="initPag.html">Inicio</a>
        <a href="prodCatalog.html">Tienda</a>
        <a href="horario.html">Disponibilidad</a>
        <a class="active" href="listas.html">Mis mascotas</a>
        <a href="regUser.html">Mi cuenta</a>
      </nav>
      <div class="header-actions">
        <button class="btn-ghost">Registrarse</button>
        <button class="btn-primary" onclick="openLogin()">Entrar</button>
      </div>
    </div>
  </header>

  <section class="hero">
    <div class="container">
      <h1>Mis mascotas</h1>
      <p class="muted">Tus mascotas guardadas, sus datos, etc.</p>
    </div>
  </section>

  <main class="container layout">
    <aside class="sidebar">
      <div class="profile-card">
        <div class="avatar">PA</div>
        <div class="profile-info">
          <strong>Patograit A.</strong>
          <small>Usuario</small>
        </div>
      </div>
      <nav class="account-nav">
        <a href="regUser.html">Mi cuenta</a>
        <a class="is-active" href="listas.html">Mis Mascotas</a>
      </nav>
    </aside>

    <section class="main">
      <article class="card">
        <h2>Registrados</h2>
        <div id="pets-grid" class="grid-cards">
          <!-- Pet cards populated dynamically -->
        </div>
      </article>

      <article class="card">
          <a class="brand" href="regPet.html"><h2>Registrar Mascota</h2></a>
        <div class="grid-cards">
        </div>
      </article>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <p>© <span id="year"></span> TechSide</p>
      <small class="muted">Términos y condiciones · Política de privacidad</small>
    </div>
  </footer>

  <script> document.getElementById('year').textContent = new Date().getFullYear(); </script>
  <!-- Pet detail modal (edit) -->
  <div id="pet-modal" class="login-modal" style="display:none" onclick="if(event.target===this) this.style.display='none'">
    <div class="login-content">
      <span class="close" onclick="document.getElementById('pet-modal').style.display='none'">&times;</span>
      <form id="pet-edit-form">
        <h2 id="pet-modal-title">Detalle mascota</h2>
        <div id="pet-fields"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button type="button" class="btn-primary" onclick="savePetChanges()">Guardar</button>
          <button type="button" class="btn-ghost" onclick="document.getElementById('pet-modal').style.display='none'">Cerrar</button>
          <button type="button" class="btn-ghost" id="btn-schedule" onclick="goToBooking()">Agendar cita</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function openPetDetail(id){
      const pets = window.__pets_cache || JSON.parse(localStorage.getItem('pets_cache')||'[]');
      const pet = pets.find(x=>x.id===id);
      if(!pet) return;
      document.getElementById('pet-modal-title').textContent = (pet.name||'Sin nombre') + ' — ' + (pet.species||'N/D');
      const container = document.getElementById('pet-fields'); container.innerHTML='';
      // full set of fields used on registration (editable)
      const fields = [
        {k:'ruac',label:'Clave RUAC'},
        {k:'name',label:'Nombre'},
        {k:'species',label:'Especie'},
        {k:'age',label:'Edad'},
        {k:'gender',label:'Género'},
        {k:'sterilized',label:'¿Esterilizado?',type:'checkbox'},
        {k:'microchipped',label:'¿Tiene microchip?',type:'checkbox'},
        {k:'microchipNumber',label:'Número de chip'},
        {k:'size',label:'Tamaño'},
        {k:'primaryColor',label:'Color primario'},
        {k:'secondaryColor',label:'Color secundario'},
        {k:'coverage',label:'Cobertura corporal'},
        {k:'weight',label:'Peso (kg)'},
        {k:'photo',label:'URL Foto'},
        {k:'provenance',label:'Procedencia'},
        {k:'outdoorSupervision',label:'Supervisión en exterior'},
        {k:'behavior',label:'Comportamiento'},
        {k:'vaccinationCard',label:'Cartilla de vacunación'},
        {k:'lastRabies',label:'Última vacuna de rabia'},
        {k:'disabled',label:'¿Discapacitada?',type:'checkbox'},
        {k:'disabilityType',label:'Tipo de discapacidad'},
        {k:'dewormed',label:'¿Desparasitada?',type:'checkbox'},
        {k:'lastDeworm',label:'Última desparasitación'},
        {k:'homeLocation',label:'Ubicación en el hogar'},
        {k:'idMethod',label:'Forma de identificación'}
      ];
      fields.forEach(f=>{
        const lbl = document.createElement('label'); lbl.textContent = f.label;
        let inp;
        if(f.type==='checkbox'){ inp = document.createElement('input'); inp.type='checkbox'; inp.name = f.k; inp.checked = !!pet[f.k]; }
        else { inp = document.createElement('input'); inp.type = f.type||'text'; inp.name = f.k; inp.value = pet[f.k]||''; }
        lbl.appendChild(inp); container.appendChild(lbl);
      });

      // show last appointment summary (if exists)
      const appointments = JSON.parse(localStorage.getItem('appointments')||'[]');
      const appt = appointments.filter(a=>a.petId===id || a.pet===pet.name).slice(-1)[0];
      if(appt){
        const info = document.createElement('div'); info.style.marginTop='8px'; info.innerHTML = `<strong>Próxima/última cita:</strong> ${appt.date||appt.day||'N/D'} ${appt.time||appt.hour||''} — ${appt.branch||appt.branchName||'N/D'} / ${appt.doctor||'N/D'}<br><strong>Procedimiento:</strong> ${appt.procedure||appt.padecimiento||'N/D'}<br><strong>Precio:</strong> ${appt.price?('$'+appt.price):'N/D'}`;
        container.appendChild(info);
      }

      // set schedule button target
      const scheduleBtn = document.getElementById('btn-schedule');
      scheduleBtn.dataset.petId = id;

      document.getElementById('pet-modal').style.display='flex';
      document.getElementById('pet-edit-form').dataset.petId = id;
    }

    function savePetChanges(){
      const form = document.getElementById('pet-edit-form');
      const id = parseInt(form.dataset.petId,10);
      const pets = window.__pets_cache || JSON.parse(localStorage.getItem('pets_cache')||'[]');
      const pet = pets.find(x=>x.id===id);
      const inputs = form.querySelectorAll('input');
      for(const inp of inputs){
        if(inp.type==='checkbox') pet[inp.name] = inp.checked; else pet[inp.name] = inp.value;
      }
      localStorage.setItem('pets_cache', JSON.stringify(pets));
      document.getElementById('pet-modal').style.display='none';
      location.reload();
    }

    function goToBooking(){
      const form = document.getElementById('pet-edit-form');
      const id = form.dataset.petId; if(!id) return; location.href = 'citas.html#pet-'+id;
    }
  </script>
  <script>
    // Populate user info and pets dynamically (ready for DB)
    (function(){
      const userName = localStorage.getItem('userName') || 'Usuario Ejemplo';
      const avatar = localStorage.getItem('userAvatar') || '../img/extras/doge.jpg';
      // Insert avatar/name into header (if present in sidebar)
      document.querySelectorAll('.profile-info strong').forEach(el=>el.textContent = userName);
      document.querySelectorAll('.avatar').forEach(av=>{ if(av.innerHTML.trim()==='PA'){ av.style.backgroundImage = `url(${avatar})`; av.style.backgroundSize='cover'; av.textContent=''; }});

      fetch('pets.json').then(r=>r.json()).then(pets=>{
        const grid = document.getElementById('pets-grid');
        // cache for modal editing
        window.__pets_cache = pets;
        pets.forEach(p=>{
          const a = document.createElement('a'); a.href='#'; a.className='card-item';
          a.dataset.petId = p.id;
          // try to find an appointment for this pet
          const appointments = JSON.parse(localStorage.getItem('appointments')||'[]');
          const appt = appointments.find(a0=> a0.petId===p.id || a0.pet===p.name);
          const apptInfo = appt ? `<div class="pet-apt"><small>${appt.branch||appt.branchName||''} • ${appt.date||appt.day||''} ${appt.time||appt.hour||''}</small></div>` : '';
          const scheduleBtn = `<div style="margin-top:6px"><a class="btn-ghost" href="citas.html#pet-${p.id}">Agendar cita</a></div>`;
          a.innerHTML = `<img src="${p.image}" alt="${p.name}"><div class="card-body"><h3>${p.name}</h3><small>${p.age} · ${p.status || ''}</small>${apptInfo}${scheduleBtn}</div>`;
          a.addEventListener('click', (e)=>{ e.preventDefault(); openPetDetail(p.id); });
          grid.appendChild(a);
        });
      }).catch(err=>{
        console.error(err);
        // fallback to local cache
        const grid = document.getElementById('pets-grid');
        const pets = JSON.parse(localStorage.getItem('pets_cache')||'[]');
        window.__pets_cache = pets;
        pets.forEach(p=>{
          const a = document.createElement('a'); a.href='#'; a.className='card-item';
          a.dataset.petId = p.id;
          a.innerHTML = `<img src="${p.image}" alt="${p.name}"><div class="card-body"><h3>${p.name}</h3><small>${p.age} · ${p.status}</small></div>`;
          a.addEventListener('click', (e)=>{ e.preventDefault(); openPetDetail(p.id); });
          grid.appendChild(a);
        });
      });
    })();
  </script>
</body>
</html>
