<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Mascota ‚Äî Expediente</title>
  <link rel="stylesheet" href="../css/universalCss.css">
  <style>
    .container-small{max-width:900px;margin:18px auto}
    .card{background:var(--card,#fff);padding:14px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.06);margin-bottom:12px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:var(--muted,#6b7280)}
    .visits .visit{border-top:1px solid rgba(0,0,0,0.04);padding:10px 0}
    .hero{margin-bottom:8px}
    .btn-link{background:transparent;border:none;color:var(--primary,#16a34a);cursor:pointer;padding:0}
    @media(max-width:800px){.grid-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="initPag.html">üê∂ TechSide Vet</a>
      <nav class="main-nav">
        <a href="initPag.html">Inicio</a>
        <a href="prodCatalog.html">Tienda</a>
        <a href="listas.html">Mis Mascotas</a>
        <a href="regUser.html">Cuenta</a>
      </nav>
      <div class="header-actions">
        <a href="cart.html" class="btn-ghost" style="position:relative;display:inline-flex;align-items:center;gap:8px">üõí <span id="cart-count" style="background:#ef4444;color:#fff;padding:2px 6px;border-radius:999px;font-weight:700">0</span></a>
        <button class="btn-primary" onclick="openLogin()">Entrar</button>
      </div>
    </div>
  </header>

  <main class="container container-small">
    <h1 class="hero">Expediente de mascota (Cliente)</h1>
    <p class="muted">Introduce la clave RUAC para ver la ficha de tu mascota. Si est√°s identificado y tienes mascotas, aparecer√°n autom√°ticamente.</p>

    <div class="card">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="ruac-input" placeholder="Clave RUAC" style="flex:1;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.08)">
        <button id="btn-view" class="btn-primary">Ver ficha</button>
        <a id="btn-schedule" class="btn-ghost" href="citas.html">Agendar cita</a>
      </div>
    </div>

    <div id="pet-card" style="display:none">
      <div class="card" id="pet-info">
        <div style="display:flex;gap:12px;align-items:flex-start">
          <img id="pet-photo" src="../img/extras/doge.jpg" alt="foto" style="width:140px;height:120px;object-fit:cover;border-radius:8px">
          <div style="flex:1">
            <h2 id="pet-name">Nombre</h2>
            <div class="muted" id="pet-meta">Especie ¬∑ Edad ¬∑ Sexo</div>
            <div style="margin-top:6px">
              <strong>Procedencia:</strong> <span id="pet-origin"></span> ¬∑ <strong>Identificaci√≥n:</strong> <span id="pet-idform"></span>
            </div>
            <div style="margin-top:6px" class="muted">Tama√±o: <span id="pet-size"></span> ¬∑ Peso: <span id="pet-weight"></span> kg</div>
          </div>
          <div style="text-align:right">
            <a id="link-edit" class="btn-ghost" style="display:none">Administrar (solo admin)</a>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Datos de salud</h3>
        <div class="grid-2">
          <div><strong>Cartilla de vacunaci√≥n:</strong> <span id="pet-vax" class="muted"></span></div>
          <div><strong>√öltima rabia:</strong> <span id="pet-last-rabia" class="muted"></span></div>
          <div><strong>Desparasitada:</strong> <span id="pet-deworm" class="muted"></span></div>
          <div><strong>√öltima desparasitaci√≥n:</strong> <span id="pet-last-dew" class="muted"></span></div>
        </div>
      </div>

      <div class="card visits">
        <h3>Historial de consultas (solo visual)</h3>
        <div id="visits-list">
          <p class="muted">No hay visitas registradas.</p>
        </div>
      </div>

      <div class="card">
        <h3>Informaci√≥n adicional</h3>
        <div><strong>Comportamiento:</strong> <span id="pet-behavior" class="muted"></span></div>
        <div><strong>Discapacitada:</strong> <span id="pet-disabled" class="muted"></span></div>
        <div><strong>Ubicaci√≥n hogar:</strong> <span id="pet-home" class="muted"></span></div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <p>¬© <span id="year"></span> TechSide</p>
      <small class="muted">T√©rminos y condiciones ¬∑ Pol√≠tica de privacidad</small>
    </div>
  </footer>

  <div id="login-modal" class="login-modal" onclick="closeOnOutsideClick(event)">
    <div class="login-content">
      <span class="close" onclick="document.getElementById('login-modal').style.display='none'">&times;</span>
      <form id="login-form" class="login-form">
        <h2>Ingresar</h2>
        <input type="email" id="login-email" placeholder="Usuario" required>
        <input type="password" id="login-password" placeholder="Contrase√±a" required>
        <button type="submit" class="btn-primary">Entrar</button>
      </form>
    </div>
  </div>

  <script> document.getElementById('year').textContent = new Date().getFullYear();</script>

  <script>
    function openLogin() { document.getElementById('login-modal').style.display = 'flex'; }
    function closeLogin() { document.getElementById('login-modal').style.display = 'none'; }
    function closeOnOutsideClick(event) {
      const modal = document.getElementById('login-modal');
      if (modal && !modal.querySelector('.login-content').contains(event.target)) closeLogin();
    }
    
    document.getElementById('login-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        fetch('/api/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, password })
        })
        .then(response => response.json())
        .then(data => {
            if (data.token) {
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                window.location.reload();
            } else {
                alert(data.message || 'Error al iniciar sesi√≥n');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al iniciar sesi√≥n');
        });
    });

    // cart count
    function getCart(){ return JSON.parse(localStorage.getItem('cart')||'[]'); }
    function updateCartCount(){ document.getElementById('cart-count').textContent = getCart().reduce((s,i)=>s+i.qty,0); }
    updateCartCount();

    document.getElementById('btn-view').addEventListener('click', ()=>{
      const ruac = document.getElementById('ruac-input').value.trim(); if(!ruac) return alert('Ingresa RUAC');
      showPet(ruac);
    });

    // If URL param ruac present, auto-load
    (function(){ const p = new URLSearchParams(window.location.search); if(p.get('ruac')){ document.getElementById('ruac-input').value = p.get('ruac'); document.getElementById('btn-view').click(); } })();

    function showPet(ruac){
      const token = localStorage.getItem('token');
      fetch(`/api/mascotas?ruac=${ruac}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(r => r.json())
      .then(pets => {
        const p = pets[0]; if(!p) return alert('Ficha no encontrada');
        document.getElementById('pet-card').style.display='block';
        document.getElementById('pet-photo').src = p.imagen_url || '../img/extras/doge.jpg';
        document.getElementById('pet-name').textContent = p.nombre || 'Sin nombre';
        document.getElementById('pet-meta').textContent = (p.tipo||'') + ' ¬∑ ' + (p.fecha_nacimiento||'') + ' ¬∑ ' + (p.sexo||'');
        document.getElementById('pet-origin').textContent = p.procedencia||''; 
        // document.getElementById('pet-idform').textContent = p.idForm||''; // No idForm in DB schema
        document.getElementById('pet-size').textContent = p.tamano||''; 
        document.getElementById('pet-weight').textContent = p.peso||'';
        // document.getElementById('pet-vax').textContent = p.cartilla||'No'; // No cartilla in DB schema
        // document.getElementById('pet-last-rabia').textContent = p.lastRabia||'N/D'; // No lastRabia in DB schema
        document.getElementById('pet-deworm').textContent = p.desparasitada ? 'S√≠' : 'No'; 
        // document.getElementById('pet-last-dew').textContent = p.lastDeworm||'N/D'; // No lastDeworm in DB schema
        document.getElementById('pet-behavior').textContent = p.comportamiento||''; 
        document.getElementById('pet-disabled').textContent = p.discapacitada ? 'S√≠' : 'No';
        document.getElementById('pet-home').textContent = p.ubicacion_hogar||'';

        // visits
        fetch(`/api/visitas?mascota_id=${p.id}`, { headers: { 'Authorization': `Bearer ${token}` } })
          .then(r => r.json())
          .then(visits => {
            const list = visits.sort((a,b)=>b.visit_at.localeCompare(a.visit_at));
            const el = document.getElementById('visits-list'); el.innerHTML='';
            if(!list.length) el.innerHTML = '<p class="muted">Sin visitas registradas.</p>';
            list.forEach(v=>{
              const d = document.createElement('div'); d.className='visit';
              d.innerHTML = `<div><strong>${new Date(v.visit_at).toLocaleString()}</strong> ‚Äî ${v.doctor_nombre||'M√©dico'}</div>
                <div><strong>Diagn√≥stico:</strong> ${escapeHtml(v.diagnosis)}</div>
                <div><strong>Tratamientos:</strong> ${escapeHtml(v.treatments)}</div>
                <div class="muted">${escapeHtml(v.notes)}</div>`;
              el.appendChild(d);
            });
          });

        // set schedule link with ruac
        document.getElementById('btn-schedule').href = 'citas.html?ruac='+encodeURIComponent(ruac);
      });
    }

    function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // if user has saved pets (session), show first
    (function(){
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user'));
      if (token && user) {
        fetch(`/api/mascotas?propietario_id=${user.id}`, { headers: { 'Authorization': `Bearer ${token}` } })
          .then(r => r.json())
          .then(pets => {
            if (pets.length > 0) {
              document.getElementById('ruac-input').value = pets[0].ruac;
              showPet(pets[0].ruac);
            }
          });
      }
    })();
  </script>
</body>
</html>
