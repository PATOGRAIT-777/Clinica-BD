<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî Citas</title>
  <link rel="stylesheet" href="../css/universalCss.css">
  <link rel="stylesheet" href="../css/sidebar.css">
  <link rel="stylesheet" href="../css/divs.css">
  <style>
    .calendar{border:1px solid rgba(0,0,0,0.08);padding:12px;border-radius:8px;background:transparent;color:inherit}
    .card{background:transparent;color:inherit}
    table{width:100%;border-collapse:collapse}
    table th, table td{padding:8px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:inherit}
  </style>
</head>
<body>
  <script>
    if (!localStorage.getItem('token')) {
      window.location.href = 'formAgregar.html';
    }
  </script>

  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="../initPag.html">üê∂ TechSide Vet</a>
      <nav class="main-nav">
        <a href="dashboard.html">Dashboard</a>
        <a href="pacientes.html">Pacientes</a>
        <a class="active" href="citas.html">Citas</a>
        <a href="inventario.html">Inventario</a>
        <a href="ordenes.html">√ìrdenes</a>
        <a href="listas.html">Mis mascotas</a>
        <a href="regPetAdmin.html">Registrar mascota</a>
        <a href="horario.html">Horario</a>
        <a href="prodCatalog.html">Tienda</a>
        <a href="regUser.html">Usuarios</a>
      </nav>
      <div class="header-actions">
        <button class="btn-primary" onclick="logout()">Salir</button>
      </div>
    </div>
  </header>
    
  <div class="container layout" style="display:flex;gap:20px;align-items:flex-start">
    <aside class="sidebar" style="min-width:220px;max-width:260px">
      <nav class="sidebar-list">
        <a href="dashboard.html">Dashboard</a>
        <a href="pacientes.html">Pacientes</a>
        <a class="active" href="citas.html">Citas</a>
        <a href="inventario.html">Inventario</a>
      </nav>
    </aside>

    <main class="main" style="flex:1">
      <h1>Citas</h1>
      <p class="muted">Agenda y gesti√≥n de citas.</p>

      <div style="display:flex;gap:12px;margin-top:12px;align-items:flex-start">
        <div style="flex:1">
          <div class="calendar">
            <h3>Reservar cita</h3>
            <div style="display:flex;gap:8px;margin-bottom:8px">
              <label style="display:flex;flex-direction:column"><span class="muted">Sucursal</span><select id="branch-select"><option>Cargando...</option></select></label>
              <label style="display:flex;flex-direction:column"><span class="muted">Doctor</span><select id="doctor-select"></select></label>
              <label style="display:flex;flex-direction:column"><span class="muted">Especialidad</span><select id="specialty-select"></select></label>
              <label style="display:flex;flex-direction:column"><span class="muted">D√≠a</span><select id="day-select"></select></label>
            </div>
            <div id="slots-list" style="display:flex;flex-direction:column;gap:6px"></div>
            <div id="booking-panel" style="display:none;border-top:1px solid rgba(0,0,0,0.06);padding-top:8px;margin-top:8px">
              <h4>Reservar cita</h4>
              <label style="display:flex;flex-direction:column"><span class="muted">Buscar due√±o</span><input id="booking-owner" placeholder="Nombre del cliente..."></label>
              <label style="display:flex;flex-direction:column"><span class="muted">Procedimiento</span><input id="booking-procedure" placeholder="Descripci√≥n del servicio"></label>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="booking-confirm" class="btn-primary">Agendar</button>
                <button id="booking-cancel" class="btn-ghost">Cancelar</button>
              </div>
            </div>
          </div>
        </div>
        <div style="width:320px">
          <div class="card" style="padding:12px;border-radius:8px;background:transparent;color:inherit">
            <h3>Pr√≥ximas citas</h3>
            <div id="upcoming-appointments"><p class="muted">Cargando...</p></div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <footer class="site-footer">
    <div class="container footer-inner">
      <p>¬© <span id="year"></span> TechSide</p>
      <small class="muted">T√©rminos y condiciones ¬∑ Pol√≠tica de privacidad</small>
    </div>
  </footer>

  <script>
    // --- L√ìGICA CONECTADA A BASE DE DATOS ---
    const API = 'http://localhost:3000/api';
    const token = localStorage.getItem('token');
    
    // Headers universales
    const headers = { 
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}` 
    };

    function logout() {
      localStorage.removeItem('token');
      window.location.href = 'formAgregar.html';
    }

    document.getElementById('year').textContent = new Date().getFullYear();

    (function(){
      const branchSelect = document.getElementById('branch-select');
      const doctorSelect = document.getElementById('doctor-select');
      const specialtySelect = document.getElementById('specialty-select');
      const daySelect = document.getElementById('day-select');
      const slotsList = document.getElementById('slots-list');
      const upcoming = document.getElementById('upcoming-appointments');

      // Variables globales para datos actuales
      let currentDoctors = []; 

      // 1. Cargar Sucursales desde BD
      function loadBranches(){
        fetch(`${API}/sucursales`, { headers })
          .then(r => r.json())
          .then(data => {
            branchSelect.innerHTML = data.map(b => `<option value="${b.id}">${b.nombre}</option>`).join('');
            // Disparar carga de doctores de la primera sucursal
            if(data.length > 0) populateDoctors(); 
          })
          .catch(err => console.error('Error sucursales:', err));
      }

      // 2. Cargar Doctores de la sucursal seleccionada
      function populateDoctors(){
        const sucId = branchSelect.value;
        if(!sucId) return;

        fetch(`${API}/sucursales/${sucId}/medicos`, { headers })
          .then(r => r.json())
          .then(doctors => {
            currentDoctors = doctors; // Guardamos para filtrar especialidades localmente
            doctorSelect.innerHTML = doctors.map(d => `<option value="${d.id}">${d.name} ‚Äî ${d.specialty || 'General'}</option>`).join('');
            populateSpecialties();
            populateDays(); // Iniciar calendario
          })
          .catch(err => console.error('Error doctores:', err));
      }

      // 3. Llenar especialidades (basado en los doctores cargados)
      function populateSpecialties(){
        // Obtenemos especialidades √∫nicas de la lista de doctores actual
        const specs = [...new Set(currentDoctors.map(d => d.specialty).filter(Boolean))];
        
        // Si hay un doctor seleccionado espec√≠ficamente, forzamos su especialidad
        const selectedDocId = doctorSelect.value;
        const selectedDoc = currentDoctors.find(d => d.id == selectedDocId);

        if(selectedDoc && selectedDoc.specialty) {
           specialtySelect.innerHTML = `<option value="${selectedDoc.specialty}">${selectedDoc.specialty}</option>`;
           specialtySelect.disabled = true; 
        } else {
           specialtySelect.disabled = false;
           if(specs.length === 0) specialtySelect.innerHTML = '<option value="">‚Äî</option>';
           else specialtySelect.innerHTML = specs.map(s => `<option value="${s}">${s}</option>`).join('');
        }
        renderSlots(); // Actualizar slots al cambiar doctor
      }

      // 4. Llenar d√≠as (Pr√≥ximos 7 d√≠as)
      function populateDays(){
        daySelect.innerHTML='';
        const today = new Date();
        for(let i=0;i<7;i++){ 
            const d=new Date(today.getFullYear(), today.getMonth(), today.getDate()+i); 
            // Formato YYYY-MM-DD para el value
            const val = d.toISOString().slice(0,10);
            daySelect.innerHTML += `<option value="${val}">${d.toLocaleDateString()}</option>` 
        }
        renderSlots();
      }

      // 5. Renderizar Slots (Consultando disponibilidad en BD)
      function renderSlots(){
        slotsList.innerHTML = '<p class="muted">Cargando disponibilidad...</p>';
        const date = daySelect.value;
        const docId = doctorSelect.value;
        const sucId = branchSelect.value;

        if(!docId) { slotsList.innerHTML = ''; return; }

        // Consultar horas ocupadas al backend
        fetch(`${API}/citas/ocupadas?fecha=${date}&medicoId=${docId}&sucursalId=${sucId}`, { headers })
          .then(r => r.json())
          .then(ocupadas => {
             // ocupadas es array tipo ['09:00', '14:00']
             slotsList.innerHTML = '';
             // Generar horario 9 a 17
             for(let h=9; h<=17; h++){
                const time = (h<10? '0'+h : ''+h) + ':00';
                const isTaken = ocupadas.includes(time);
                
                const btn = document.createElement('button');
                // Usamos tus clases originales
                btn.className = isTaken ? 'btn-ghost' : 'btn-primary'; 
                btn.textContent = time + (isTaken ? ' ‚Äî Ocupado' : ' ‚Äî Reservar');
                btn.disabled = isTaken;
                
                if(!isTaken){
                    btn.addEventListener('click', ()=>openBookingPanel(date, time));
                }
                slotsList.appendChild(btn);
             }
          })
          .catch(e => slotsList.innerHTML = '<p class="error">Error de conexi√≥n</p>');
      }

      // 6. Abrir Panel (Igual que antes, solo visual)
      function openBookingPanel(date, time){
        const panel = document.getElementById('booking-panel');
        panel.dataset.date = date; 
        panel.dataset.time = time; 
        panel.style.display = 'block';
        document.getElementById('booking-owner').focus();
      }

      // 7. Confirmar Cita (Guardar en BD)
      document.getElementById('booking-confirm').addEventListener('click', ()=>{
        const owner = document.getElementById('booking-owner').value.trim();
        const procedure = document.getElementById('booking-procedure').value.trim();
        if(!owner){ alert('Ingresa el nombre del due√±o.'); return; }
        
        const panel = document.getElementById('booking-panel');
        
        const payload = {
            sucursal: branchSelect.value,
            doctor: doctorSelect.value,
            date: panel.dataset.date,
            time: panel.dataset.time,
            owner: owner,
            procedure: procedure
        };

        fetch(`${API}/citas`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload)
        })
        .then(async r => {
            if(r.ok) {
                alert('¬°Cita agendada exitosamente!');
                panel.style.display='none';
                document.getElementById('booking-owner').value = '';
                document.getElementById('booking-procedure').value = '';
                renderSlots(); // Recargar para ver el nuevo bloqueo
            } else {
                const err = await r.json();
                alert('Error: ' + err.message);
            }
        })
        .catch(e => alert('Error de red'));
      });

      document.getElementById('booking-cancel').addEventListener('click', ()=>{ 
        document.getElementById('booking-panel').style.display='none'; 
      });

      // Event Listeners
      branchSelect.addEventListener('change', populateDoctors);
      doctorSelect.addEventListener('change', ()=>{ populateSpecialties(); }); 
      // Si cambias especialidad, no filtramos doctores por simplicidad, solo recargamos slots
      specialtySelect.addEventListener('change', renderSlots);
      daySelect.addEventListener('change', renderSlots);

      // Iniciar
      loadBranches();
      
    })();
  </script>
</body>
</html>