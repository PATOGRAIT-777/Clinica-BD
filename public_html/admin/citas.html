<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî Citas</title>
  <link rel="stylesheet" href="../css/universalCss.css">
  <link rel="stylesheet" href="../css/sidebar.css">
  <link rel="stylesheet" href="../css/divs.css">
  <style>
    .calendar{border:1px solid rgba(0,0,0,0.08);padding:12px;border-radius:8px;background:transparent;color:inherit}
    .card{background:transparent;color:inherit}
    table{width:100%;border-collapse:collapse}
    table th, table td{padding:8px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:inherit}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="../initPag.html">üê∂ TechSide Vet</a>
      <nav class="main-nav">
        <a href="dashboard.html">Dashboard</a>
        <a href="pacientes.html">Pacientes</a>
        <a class="active" href="citas.html">Citas</a>
        <a href="inventario.html">Inventario</a>
        <a href="ordenes.html">√ìrdenes</a>
          <a href="listas.html">Mis mascotas</a>
          <a href="regPetAdmin.html">Registrar mascota</a>
          <a href="horario.html">Horario</a>
          <a href="prodCatalog.html">Tienda</a>
          <a href="regUser.html">Usuarios</a>
      </nav>
      <div class="header-actions">
        <button class="btn-ghost"><a href="formAgregar.html">Registrarse</a></button>
        <button class="btn-primary" onclick="openLogin()">Entrar</button>
      </div>
    </div>
  </header>
    
  <div id="login-modal" class="login-modal" onclick="closeOnOutsideClick(event)">
    <div class="login-content">
      <span class="close" onclick="document.getElementById('login-modal').style.display='none'">&times;</span>
      <form id="login-form" class="login-form">
        <h2>Ingresar</h2>
        <input type="email" id="login-email" placeholder="Usuario" required>
        <input type="password" id="login-password" placeholder="Contrase√±a" required>
        <button type="submit" class="btn-primary">Entrar</button>
      </form>
    </div>
  </div>

    <script>
    function openLogin() { document.getElementById('login-modal').style.display = 'flex'; }
    function closeLogin() { document.getElementById('login-modal').style.display = 'none'; }
    function closeOnOutsideClick(event) { const modal = document.getElementById('login-modal'); if (modal && !modal.querySelector('.login-content').contains(event.target)) closeLogin(); }
    
    document.getElementById('login-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        fetch('/api/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, password })
        })
        .then(response => response.json())
        .then(data => {
            if (data.token) {
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                window.location.reload();
            } else {
                alert(data.message || 'Error al iniciar sesi√≥n');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al iniciar sesi√≥n');
        });
    });
    </script>

    
  <div class="container layout" style="display:flex;gap:20px;align-items:flex-start">
    <aside class="sidebar" style="min-width:220px;max-width:260px">
      <nav class="sidebar-list">
        <a href="dashboard.html">Dashboard</a>
        <a href="pacientes.html">Pacientes</a>
        <a class="active" href="citas.html">Citas</a>
        <a href="inventario.html">Inventario</a>
      </nav>
    </aside>

    <main class="main" style="flex:1">
      <h1>Citas</h1>
      <p class="muted">Agenda y gesti√≥n de citas.</p>

      <div style="display:flex;gap:12px;margin-top:12px;align-items:flex-start">
        <div style="flex:1">
          <div class="calendar">
            <h3>Reservar cita</h3>
            <div style="display:flex;gap:8px;margin-bottom:8px">
              <label style="display:flex;flex-direction:column"><span class="muted">Sucursal</span><select id="branch-select"></select></label>
              <label style="display:flex;flex-direction:column"><span class="muted">Doctor</span><select id="doctor-select"></select></label>
              <label style="display:flex;flex-direction:column"><span class="muted">Especialidad</span><select id="specialty-select"></select></label>
              <label style="display:flex;flex-direction:column"><span class="muted">D√≠a</span><select id="day-select"></select></label>
            </div>
            <div id="slots-list" style="display:flex;flex-direction:column;gap:6px"></div>
            <!-- booking panel -->
            <div id="booking-panel" style="display:none;border-top:1px solid rgba(0,0,0,0.06);padding-top:8px;margin-top:8px">
              <h4>Reservar cita</h4>
              <label style="display:flex;flex-direction:column"><span class="muted">Buscar due√±o</span><input id="booking-owner" list="owners-list" placeholder="Escribe para buscar..."><datalist id="owners-list"></datalist></label>
              <label style="display:flex;flex-direction:column"><span class="muted">Procedimiento</span><input id="booking-procedure" placeholder="Descripci√≥n del servicio"></label>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="booking-confirm" class="btn-primary">Agendar</button>
                <button id="booking-cancel" class="btn-ghost">Cancelar</button>
              </div>
            </div>
          </div>
        </div>
        <div style="width:320px">
          <div class="card" style="padding:12px;border-radius:8px;background:transparent;color:inherit">
            <h3>Pr√≥ximas citas</h3>
            <div id="upcoming-appointments"><p class="muted">Cargando...</p></div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <footer class="site-footer">
    <div class="container footer-inner">
      <p>¬© <span id="year"></span> TechSide</p>
      <small class="muted">T√©rminos y condiciones ¬∑ Pol√≠tica de privacidad</small>
    </div>
  </footer>

  <script>
    (function() {
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user'));

        if (!token || !user) {
            window.location.href = 'formAgregar.html';
            return;
        }

        const isRecepcionista = user.rol === 'recepcionista';
        const isMedico = user.rol === 'medico';
        const isCliente = user.rol === 'cliente';

        if (!isRecepcionista && !isMedico && !isCliente) {
            window.location.href = 'formAgregar.html';
            return;
        }

        const bookingOwnerInput = document.getElementById('booking-owner');
        if (isCliente) {
            bookingOwnerInput.value = user.nombre_completo;
            bookingOwnerInput.disabled = true;
        }

        const branchSelect = document.getElementById('branch-select');
        const doctorSelect = document.getElementById('doctor-select');
        const specialtySelect = document.getElementById('specialty-select');
        const daySelect = document.getElementById('day-select');
        const slotsList = document.getElementById('slots-list');
        const upcoming = document.getElementById('upcoming-appointments');
        let branches = [];

        function loadBranches(){
            fetch('/api/sucursales', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
            }).then(r=>r.json()).then(j=>{
            branches = j || [];
            branchSelect.innerHTML = branches.map(b=>`<option value="${b.id}">${b.nombre}</option>`).join('');
            branchSelect.dispatchEvent(new Event('change'));
            renderUpcoming();
            }).catch(err=>{ console.error(err); upcoming.innerHTML='<p class="muted">No se pudieron cargar sucursales.</p>'; });
        }

        function populateDoctors(){
            fetch('/api/doctores', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
            }).then(r => r.json()).then(doctors => {
            doctorSelect.innerHTML = (doctors||[]).map(d=>`<option value="${d.id}">${d.nombre} ‚Äî ${d.especialidad}</option>`).join('');
            populateSpecialties();
            populateDays();
            });
        }

        function populateSpecialties(){
            fetch('/api/doctores', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
            }).then(r => r.json()).then(doctors => {
            const specs = Array.from(new Set((doctors||[]).map(d=>d.especialidad).filter(Boolean)));
            const selectedDoctor = (doctors||[]).find(d=>String(d.id)===String(doctorSelect.value));
            if(selectedDoctor){
                specialtySelect.innerHTML = `<option value="${selectedDoctor.especialidad}">${selectedDoctor.especialidad}</option>`;
                specialtySelect.disabled = true;
            } else {
                specialtySelect.disabled = false;
                if(specs.length===0){ specialtySelect.innerHTML = '<option value="">‚Äî</option>'; }
                else { specialtySelect.innerHTML = specs.map(s=>`<option value="${s}">${s}</option>`).join(''); }
            }
            });
        }

        function populateDays(){
            daySelect.innerHTML='';
            const today = new Date();
            for(let i=0;i<7;i++){ const d=new Date(today.getFullYear(), today.getMonth(), today.getDate()+i); daySelect.innerHTML += `<option value="${d.toISOString().slice(0,10)}">${d.toLocaleDateString()}</option>` }
            daySelect.dispatchEvent(new Event('change'));
        }

        function renderSlots(){
            slotsList.innerHTML='';
            const date = daySelect.value;
            fetch(`/api/citas?fecha=${date}&sucursal_id=${branchSelect.value}&medico_id=${doctorSelect.value}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
            }).then(r => r.json()).then(appointments => {
            for(let h=9; h<=17; h++){
                const time = (h<10? '0'+h : ''+h) + ':00';
                const taken = appointments.find(a=>a.hora_inicio===time);
                const btn = document.createElement('button'); btn.className = taken? 'btn-ghost' : 'btn-primary'; btn.textContent = time + (taken? ' ‚Äî Ocupado':' ‚Äî Reservar');
                btn.disabled = !!taken;
                btn.addEventListener('click', ()=>openBookingPanel(date, time));
                slotsList.appendChild(btn);
            }
            });
        }

        function openBookingPanel(date, time){
            const panel = document.getElementById('booking-panel'); panel.dataset.date = date; panel.dataset.time = time; panel.style.display = 'block';
            if (isCliente) {
                const ownerInput = document.getElementById('booking-owner');
                ownerInput.value = user.nombre_completo;
                ownerInput.disabled = true;
            }
        }

        document.getElementById('booking-cancel').addEventListener('click', ()=>{ document.getElementById('booking-panel').style.display='none'; });
        document.getElementById('booking-confirm').addEventListener('click', ()=>{
            const ownerInput = document.getElementById('booking-owner');
            const ownerName = ownerInput.value.trim();
            const procedure = document.getElementById('booking-procedure').value.trim();
            if(!ownerName){ alert('Ingresa o selecciona el due√±o.'); return; }
            const panel = document.getElementById('booking-panel');
            const date = panel.dataset.date;
            const time = panel.dataset.time;

            Promise.all([
            fetch(`/api/usuarios?nombre_completo=${ownerName}`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
            fetch('/api/mascotas', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json())
            ]).then(([users, pets]) => {
            const owner = users[0];
            if (!owner) {
                alert('Due√±o no encontrado');
                return;
            }
            const petIdForAppointment = panel.dataset.petId || null;
            const pet = pets.find(p => p.propietario_id === owner.id);
            if (!pet) {
                alert('Mascota no encontrada');
                return;
            }

            const appt = {
                mascota_id: pet.id,
                medico_id: doctorSelect.value,
                sucursal_id: branchSelect.value,
                fecha: date,
                hora_inicio: time,
                procedimiento: procedure
            };

            fetch('/api/citas', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(appt)
            }).then(r => {
                if (r.ok) {
                panel.style.display = 'none';
                renderSlots();
                renderUpcoming();
                alert('Cita agendada');
                } else {
                alert('Error al agendar la cita');
                }
            });
            });
        });

        function renderUpcoming(){
            fetch('/api/citas', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
            }).then(r => r.json()).then(appointments => {
            if(!appointments.length){ upcoming.innerHTML='<p class="muted">No hay citas pr√≥ximas.</p>'; return; }
            const list = document.createElement('ul');
            appointments.slice(-10).reverse().forEach(a=>{
                const li = document.createElement('li'); li.textContent = `${a.fecha} ${a.hora_inicio} ‚Äî ${a.propietario_nombre} ‚Äî ${a.sucursal_nombre} / ${a.medico_nombre}`;
                list.appendChild(li);
            });
            upcoming.innerHTML=''; upcoming.appendChild(list);
            });
        }

        branchSelect.addEventListener('change', populateDoctors);
        doctorSelect.addEventListener('change', ()=>{ populateSpecialties(); renderSlots(); });
        specialtySelect.addEventListener('change', renderSlots);
        daySelect.addEventListener('change', renderSlots);

        loadBranches();
    })();
  </script>
</body>
</html>