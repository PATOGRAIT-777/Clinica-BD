<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>— TechSide</title>
  <link rel="stylesheet" href="../css/userSet.css">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="/">Clinica</a>
      <nav class="main-nav" aria-label="Navegación principal">
        <a class="active" href="initPag.html">Inicio</a>
        <a href="prodCatalog.html">Tienda</a>
        <a href="horario.html">Disponibilidad</a>
        <a href="listas.html">Mis mascotas</a>
        <a href="regUser.html">Mi cuenta</a>
      </nav>
      <div class="header-actions">
        <button class="btn-ghost" onclick="logout()">Salir</button>
      </div>
    </div>
  </header>

  <!-- Hero pequeño / breadcrumbs -->
  <section class="hero">
    <div class="container">
      <h1>Mi cuenta</h1>
      <p class="muted">Gestiona tu perfil, contraseñas, mascotas y ajustes.</p>
    </div>
  </section>

  <!-- Contenido principal: sidebar + main -->
  <main class="container layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="profile-card">
        <div class="avatar">PA</div>
        <div class="profile-info">
          <strong id="profile-name"></strong>
          <small id="profile-role"></small>
        </div>
      </div>

      <nav class="account-nav">
        <a href="#perfil" class="is-active">Perfil</a>
        <a href="listas.html">Mis mascotas</a>
        <a href="#ajustes">Ajustes</a>
        <button id="logoutBtn" class="btn-ghost" style="width:100%;text-align:left">Cerrar sesión</button>
      </nav>
    </aside>

    <!-- Main -->
    <section class="main">
      <!-- Perfil / formulario -->
      <article id="perfil" class="card">
        <h2>Información del perfil</h2>
        <form id="profile-form" class="form-grid" autocomplete="off">
          <label>
            Nombre
            <input type="text" name="nombre_completo" />
          </label>

          <label>
            Email
            <input type="email" name="email" />
          </label>

          <div class="form-actions full">
            <button type="submit" class="btn-primary">Guardar cambios</button>
          </div>
        </form>
      </article>

      <!-- Seguridad -->
      <article id="ajustes" class="card">
        <h2>Seguridad</h2>
        <form id="password-form" class="form-grid">
          <label>
            Nueva contraseña
            <input type="password" name="newpass" />
          </label>

          <label>
            Repetir nueva contraseña
            <input type="password" name="newpass2" />
          </label>

          <div class="form-actions full">
            <button type="submit" class="btn-primary">Actualizar contraseña</button>
          </div>
        </form>
      </article>
    </section>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container footer-inner">
      <p>© <span id="year"></span> TechSide</p>
      <small class="muted">Términos y condiciones · Política de privacidad</small>
    </div>
  </footer>

  <script>
    (function() {
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user'));

        if (!token || !user) {
            window.location.href = 'formAgregar.html';
            return;
        }

        document.getElementById('profile-name').textContent = user.nombre;
        document.getElementById('profile-role').textContent = user.rol;

        const profileForm = document.getElementById('profile-form');
        profileForm.querySelector('input[name="nombre_completo"]').value = user.nombre;
        profileForm.querySelector('input[name="email"]').value = user.email;

        profileForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const nombre_completo = this.querySelector('input[name="nombre_completo"]').value;
            const email = this.querySelector('input[name="email"]').value;
            
            fetch(`/api/usuarios/${user.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ nombre_completo, email })
            }).then(r => r.json()).then(updatedUser => {
                alert('Perfil actualizado');
                localStorage.setItem('user', JSON.stringify(updatedUser));
                window.location.reload();
            }).catch(() => alert('Error al actualizar el perfil'));
        });

        const passwordForm = document.getElementById('password-form');
        passwordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const newPassword = this.querySelector('input[name="newpass"]').value;
            const newPassword2 = this.querySelector('input[name="newpass2"]').value;

            if (newPassword !== newPassword2) {
                alert('Las contraseñas no coinciden');
                return;
            }

            fetch(`/api/usuarios/${user.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ password: newPassword })
            }).then(r => {
                if (r.ok) {
                    alert('Contraseña actualizada');
                    passwordForm.reset();
                } else {
                    alert('Error al actualizar la contraseña');
                }
            });
        });

        document.getElementById('logoutBtn').addEventListener('click', ()=>{
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'formAgregar.html';
        });
    })();
  </script>
</body>
</html>