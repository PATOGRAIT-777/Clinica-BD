<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Horario — TechSide Vet</title>
  <link rel="stylesheet" href="../css/universalCss.css" type="text/css">
</head>

<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="/">Clinica</a>
      <nav class="main-nav" aria-label="Navegación principal">
        <a class="active" href="initPag.html">Inicio</a>
        <a href="prodCatalog.html">Tienda</a>
        <a href="horario.html">Disponibilidad</a>
        <a href="listas.html">Mis mascotas</a>
        <a href="regUser.html">Mi cuenta</a>
      </nav>
      <div class="header-actions">
        <button class="btn-ghost" onclick="logout()">Salir</button>
      </div>
    </div>
  </header>

    <script>
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'formAgregar.html';
        }
    </script>

  <section class="hero">
    <div class="container">
      <h1>Horario</h1>
      <p class="muted">Próximos episodios / lanzamientos</p>
    </div>
  </section>

  <main class="container layout">
    <section class="main" style="width:100%">
      <article class="card">
        <h2>Calendario — próximas 2 semanas</h2>
        <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
          <label style="display:flex;flex-direction:column"><span class="muted">Sucursal</span><select id="branch-select"></select></label>
          <label style="display:flex;flex-direction:column"><span class="muted">Doctor</span><select id="doctor-select"></select></label>
          <label style="display:flex;flex-direction:column"><span class="muted">Fecha inicio</span><input type="date" id="date-focus"></label>
          <label style="display:flex;flex-direction:column"><span class="muted">Fecha fin</span><input type="date" id="date-end"></label>
        </div>
        <div id="calendar-2weeks" style="display:grid;grid-template-columns:repeat(7,1fr);gap:12px;margin-top:12px"></div>
      </article>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <p>© <span id="year"></span> TechSide</p>
      <small class="muted">Términos y condiciones · Política de privacidad</small>
    </div>
  </footer>

  <script> document.getElementById('year').textContent = new Date().getFullYear(); </script>
  <script>
    (function(){
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user'));

        if (!token || !user) {
            window.location.href = 'formAgregar.html';
            return;
        }

        const isAdmin = user.rol === 'admin';
        const isRecepcionista = user.rol === 'recepcionista';
        const isMedico = user.rol === 'medico';

        if (!isAdmin && !isRecepcionista && !isMedico) {
            window.location.href = 'formAgregar.html';
            return;
        }

        const container = document.getElementById('calendar-2weeks');
        const branchSelect = document.getElementById('branch-select');
        const doctorSelect = document.getElementById('doctor-select');
        const dateFocus = document.getElementById('date-focus');
        let branches = [];
        let doctors = [];

        function loadBranches(){
            fetch('/api/sucursales', { headers: { 'Authorization': `Bearer ${token}` } })
            .then(r=>r.json()).then(j=>{
            branches = j || [];
            branchSelect.innerHTML = branches.map(b=>`<option value="${b.id}">${b.nombre}</option>`).join('');
            branchSelect.dispatchEvent(new Event('change'));
            }).catch(err=>{
            console.error('No pude cargar branches.json', err);
            });
        }

        function populateDoctors(){
            fetch('/api/doctores', { headers: { 'Authorization': `Bearer ${token}` } })
            .then(r => r.json()).then(docs => {
                doctors = docs || [];
                if (isMedico) {
                    const medico = doctors.find(d => d.usuario_id === user.id);
                    if (medico) {
                        doctorSelect.innerHTML = `<option value="${medico.id}">${medico.nombre}</option>`;
                        doctorSelect.disabled = true;
                    }
                } else {
                    doctorSelect.innerHTML = doctors.map(d=>`<option value="${d.id}">${d.nombre} — ${d.especialidad}</option>`).join('');
                }
                renderCalendar();
            });
        }

        function renderCalendar(){
            container.innerHTML = '';
            const start = document.getElementById('date-focus').value ? new Date(document.getElementById('date-focus').value) : new Date();
            const endInput = document.getElementById('date-end').value;
            const end = endInput ? new Date(endInput) : new Date(start.getFullYear(), start.getMonth(), start.getDate()+13);
            
            if(end < start){ container.innerHTML = '<p class="muted">Rango inválido: la fecha fin es anterior a la fecha inicio.</p>'; return; }

            fetch(`/api/citas?fecha_inicio=${start.toISOString().slice(0,10)}&fecha_fin=${end.toISOString().slice(0,10)}&sucursal_id=${branchSelect.value}&medico_id=${doctorSelect.value}`, { headers: { 'Authorization': `Bearer ${token}` } })
            .then(r => r.json()).then(appointments => {
                for(let d = 0, cur = new Date(start.getFullYear(), start.getMonth(), start.getDate()); cur <= end; d++, cur = new Date(start.getFullYear(), start.getMonth(), start.getDate()+d)){
                    const date = new Date(cur);
                    const iso = date.toISOString().slice(0,10);
                    const card = document.createElement('div'); card.className='card';
                    const title = document.createElement('h3'); title.textContent = date.toLocaleDateString(); title.style.color = 'var(--accent,#16a34a)'; card.appendChild(title);
                    const list = document.createElement('div');
                    for(let h=8; h<=18; h++){
                        const hh = (h<10? '0'+h : ''+h)+':00';
                        const slot = document.createElement('div'); slot.style.marginBottom='6px';
                        const btn = document.createElement('button');
                        btn.textContent = hh;
                        const exists = appointments.find(a=>a.fecha===iso && a.hora_inicio===hh);
                        if(exists){ btn.disabled = true; btn.textContent = hh + ' — Ocupado'; btn.className='btn-ghost'; }
                        else { btn.className='btn-available'; btn.style.background='#16a34a'; btn.style.color='#fff'; }
                        slot.appendChild(btn); list.appendChild(slot);
                    }
                    card.appendChild(list); container.appendChild(card);
                }
                container.style.gridAutoRows = 'minmax(120px,auto)';
            });
        }

        branchSelect.addEventListener('change', populateDoctors);
        doctorSelect.addEventListener('change', renderCalendar);
        dateFocus.addEventListener('change', renderCalendar);
        document.getElementById('date-end').addEventListener('change', renderCalendar);

        loadBranches();
    })();
  </script>
</body>
</html>