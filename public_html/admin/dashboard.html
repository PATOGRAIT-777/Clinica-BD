<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî Dashboard</title>
  <link rel="stylesheet" href="../css/universalCss.css">
  <link rel="stylesheet" href="../css/sidebar.css">
  <link rel="stylesheet" href="../css/divs.css">
  <style>
    .admin-cards{display:flex;gap:16px;flex-wrap:wrap}
    .card-metric{flex:1 1 200px;padding:18px;background:#1f2937;color:#fff;border-radius:8px}
    table{width:100%;border-collapse:collapse}
    table th,table td{padding:8px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:inherit}
    .main{padding:20px}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="../initPag.html">üê∂ TechSide Vet</a>
      <nav class="main-nav">
        <a href="../initPag.html">Inicio</a>
        <a href="dashboard.html" class="active">Dashboard</a>
        <a href="pacientes.html">Pacientes</a>
        <a href="citas.html">Citas</a>
        <a href="inventario.html">Inventario</a>
        <a href="ordenes.html">√ìrdenes</a>
          <a href="dashboard.html">Dashboard</a>
          <a href="citas.html">Citas</a>
          <a href="expedientes.html">Expedientes</a>
          <a href="listas.html">Mis mascotas</a>
          <a href="regPetAdmin.html">Registrar mascota</a>
          <a href="pacientes.html">Pacientes</a>
          <a href="horario.html">Horario</a>
          <a href="inventario.html">Inventario</a>
          <a href="ordenes.html">√ìrdenes</a>
          <a href="prodCatalog.html">Tienda</a>
          <a href="regUser.html">Mi cuenta</a>
      </nav>
      <div class="header-actions">
        <button class="btn-ghost" onclick="logout()">Salir</button>
      </div>
    </div>
  </header>

  <script>
      function logout() {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = 'formAgregar.html';
      }
  </script>

  <div class="container layout" style="display:flex;gap:20px;align-items:flex-start">
    <aside class="sidebar" style="min-width:220px;max-width:260px">
      <nav class="sidebar-list">
        <a href="dashboard.html">Dashboard</a>
        <a href="pacientes.html">Pacientes</a>
        <a href="citas.html">Citas</a>
        <a href="inventario.html">Inventario</a>
        <a href="ordenes.html">√ìrdenes</a>
      </nav>
    </aside>

    <main class="main" style="flex:1">
      <h1>Panel administrativo</h1>
      <p class="muted">Vista r√°pida de actividad y m√©tricas.</p>

      <div class="admin-cards">
        <div class="card-metric">
          <h3>Citas hoy</h3>
          <p style="font-size:24px" id="citas-hoy">0</p>
        </div>
        <div class="card-metric">
          <h3>Pacientes</h3>
          <p style="font-size:24px" id="pacientes">0</p>
        </div>
        <div class="card-metric" id="pedidos-card">
          <h3>Pedidos pendientes</h3>
          <p style="font-size:24px" id="pedidos-pendientes">0</p>
        </div>
        <div class="card-metric" id="stock-card">
          <h3>Productos en stock</h3>
          <p style="font-size:24px" id="productos-stock">0</p>
        </div>
      </div>

      <section style="margin-top:24px">
        <h2>Pr√≥ximas citas</h2>
        <table>
          <thead><tr><th>Hora</th><th>Paciente</th><th>Due√±o</th><th>Servicio</th><th>Sucursal</th><th>Doctor</th><th>Estado</th></tr></thead>
          <tbody id="dashboard-appointments-body">
          </tbody>
        </table>
      </section>

    </main>
  </div>

  <footer class="site-footer">
    <div class="container footer-inner">
      <p>¬© <span id="year"></span> TechSide</p>
      <small class="muted">T√©rminos y condiciones ¬∑ Pol√≠tica de privacidad</small>
    </div>
  </footer>

  <script>
    (function() {
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user'));

        if (!token || !user) {
            window.location.href = 'formAgregar.html';
            return;
        }

        const isAdmin = user.rol === 'admin';
        const isRecepcionista = user.rol === 'recepcionista';
        const isMedico = user.rol === 'medico';

        if (!isAdmin && !isRecepcionista && !isMedico) {
            window.location.href = 'formAgregar.html';
            return;
        }

        if (isMedico) {
            document.getElementById('pedidos-card').style.display = 'none';
            document.getElementById('stock-card').style.display = 'none';
        }

        const today = new Date().toISOString().slice(0, 10);
        fetch(`/api/citas?fecha=${today}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('citas-hoy').textContent = data.length;
        })
        .catch(error => console.error('Error:', error));

        fetch('/api/mascotas', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('pacientes').textContent = data.length;
        })
        .catch(error => console.error('Error:', error));

        if (isAdmin || isRecepcionista) {
            fetch('/api/ordenes?estado=pendiente', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('pedidos-pendientes').textContent = data.length;
            })
            .catch(error => console.error('Error:', error));

            fetch('/api/productos', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const stock = data.reduce((acc, product) => acc + product.stock, 0);
                document.getElementById('productos-stock').textContent = stock;
            })
            .catch(error => console.error('Error:', error));
        }

        fetch('/api/citas', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('dashboard-appointments-body');
            tbody.innerHTML = '';
            data.forEach(cita => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cita.hora_inicio}</td>
                    <td>${cita.mascota_nombre}</td>
                    <td>${cita.propietario_nombre}</td>
                    <td>${cita.procedimiento}</td>
                    <td>${cita.sucursal_nombre}</td>
                    <td>${cita.medico_nombre}</td>
                    <td>${cita.estado}</td>
                `;
                tbody.appendChild(tr);
            });
        })
        .catch(error => console.error('Error:', error));
    })();
  </script>
</body>
</html>
