<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expedientes ‚Äî TechSide Vet</title>
  <link rel="stylesheet" href="../css/universalCss.css">
  <link rel="stylesheet" href="../css/sidebar.css">
  <style>
    .layout-two{display:flex;gap:20px;align-items:flex-start}
    .panel{background:var(--card,#fff);padding:14px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
    .left{flex:0 0 420px}
    .right{flex:1}
    .field{display:flex;flex-direction:column;margin-bottom:8px}
    .field label{font-weight:600;margin-bottom:4px}
    .row{display:flex;gap:8px}
    .row .field{flex:1}
    .muted{color:var(--muted,#6b7280)}
    .visit-item{border-top:1px dashed rgba(0,0,0,0.06);padding:8px 0}
    .small{font-size:13px}
    .stats{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .stat{background:linear-gradient(160deg,#0840c2 0%, var(--bg) 100%);padding:8px;border-radius:6px}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
        <a class="brand" href="initPag.html">üê∂ TechSide Vet</a>
        <nav class="main-nav" aria-label="Navegaci√≥n principal">
          <a href="dashboard.html">Dashboard</a>
          <a href="citas.html">Citas</a>
          <a href="expedientes.html" class="active">Expedientes</a>
          <a href="listas.html">Mis mascotas</a>
          <a href="regPetAdmin.html">Registrar mascota</a>
          <a href="pacientes.html">Pacientes</a>
          <a href="horario.html">Horario</a>
          <a href="inventario.html">Inventario</a>
          <a href="ordenes.html">√ìrdenes</a>
          <a href="prodCatalog.html">Tienda</a>
          <a href="regUser.html">Usuarios</a>
      </nav>
      <div class="header-actions">
        <a href="cart.html" class="btn-ghost" style="position:relative;display:inline-flex;align-items:center;gap:8px">üõí <span id="cart-count" style="background:#ef4444;color:#fff;padding:2px 6px;border-radius:999px;font-weight:700">0</span></a>
        <button class="btn-primary" onclick="openLogin()">Entrar</button>
      </div>
    </div>
  </header>

  <main class="container" style="margin-top:20px">
    <h1>Expedientes de mascotas</h1>
    <p class="muted">Registra datos personales, f√≠sicos y el historial cl√≠nico.</p>

    <div class="layout-two">
      <aside class="left panel">
        <h3>Ficha b√°sica</h3>
        <div class="field"><label>Clave RUAC</label><input id="ruac" placeholder="Alfanum√©rico"></div>
        <div class="field"><label>Nombre</label><input id="pet-name"></div>
        <div class="row">
          <div class="field"><label>Especie</label><select id="specie"><option>Perro</option><option>Gato</option><option>Ave</option><option>Reptil</option><option>Otro</option></select></div>
          <div class="field"><label>Edad</label><input id="age"></div>
        </div>
        <div class="row">
          <div class="field"><label>G√©nero</label><select id="gender"><option>Macho</option><option>Hembra</option></select></div>
          <div class="field"><label>¬øEsteril?</label><select id="steril"><option>No</option><option>S√≠</option></select></div>
        </div>
        <div class="row">
          <div class="field"><label>Microchip</label><select id="has-chip"><option>No</option><option>S√≠</option></select></div>
          <div class="field"><label>N√∫mero de chip</label><input id="chip-number"></div>
        </div>

        <h3 style="margin-top:12px">Caracter√≠sticas f√≠sicas</h3>
        <div class="row">
          <div class="field"><label>Tama√±o</label><select id="size"><option>Chico</option><option>Mediano</option><option>Grande</option><option>Muy grande</option></select></div>
          <div class="field"><label>Peso (kg)</label><input id="weight" type="number" step="0.1"></div>
        </div>
        <div class="row">
          <div class="field"><label>Color primario</label><input id="color-primary"></div>
          <div class="field"><label>Color secundario</label><input id="color-secondary"></div>
        </div>
        <div class="field"><label>Cobertura corporal</label><input id="cover"></div>

        <h3 style="margin-top:12px">Informaci√≥n adicional</h3>
        <div class="row">
          <div class="field"><label>Procedencia</label><select id="origin"><option>Adopci√≥n</option><option>Rescatada</option><option>Donada</option><option>Heredada</option><option>Comprada</option></select></div>
          <div class="field"><label>Supervisi√≥n exterior</label><select id="external"><option>S√≠</option><option>No</option></select></div>
        </div>
        <div class="row">
          <div class="field"><label>Comportamiento</label><select id="behavior"><option>Amigable</option><option>Aggresivo</option><option>Neutral</option></select></div>
          <div class="field"><label>Discapacitada</label><select id="disabled"><option>No</option><option>S√≠</option></select></div>
        </div>

        <div class="row">
          <div class="field"><label>Desparasitada</label><select id="dewormed"><option>S√≠</option><option>No</option></select></div>
          <div class="field"><label>√öltima desparasitaci√≥n</label><input id="last-deworm" type="date"></div>
        </div>

        <div class="field"><label>Ubicaci√≥n en el hogar</label><select id="home-location"><option>Interior</option><option>Exterior</option></select></div>
        <div class="field"><label>Forma de identificaci√≥n</label><input id="id-form"></div>
        <div class="field"><label>Fotograf√≠a (URL)</label><input id="photo-url"></div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn-primary" id="save-pet">Guardar ficha</button>
          <button class="btn-ghost" id="load-pet">Cargar por RUAC</button>
        </div>

      </aside>

      <section class="right">
        <div class="panel">
          <h3>Registrar consulta (Doctor)</h3>
          <div class="field"><label>Doctor (inicia sesi√≥n)</label>
            <select id="doctor-select"></select>
          </div>
          <div class="field"><label>Signos</label><input id="signs"></div>
          <div class="field"><label>S√≠ntomas</label><textarea id="symptoms" rows="2"></textarea></div>
          <div class="row">
            <div class="field"><label>Prediagn√≥stico</label><input id="predi"></div>
            <div class="field"><label>Diagn√≥stico</label><input id="diag"></div>
          </div>
          <div class="field"><label>Procedimiento (select)</label>
            <select id="procedure-select">
              <option>Vacunaci√≥n</option>
              <option>Cirug√≠a</option>
              <option>Consulta</option>
              <option>Desparasitaci√≥n</option>
              <option>Consulta dental</option>
            </select>
          </div>
          <div class="field"><label>Descripci√≥n del padecimiento (max 300)</label><textarea id="padecimiento" maxlength="300" rows="3"></textarea></div>
          <div class="field"><label>Medicamentos y tratamiento</label><textarea id="treatment" rows="2"></textarea></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn-primary" id="save-visit">Guardar visita</button>
            <button class="btn-ghost" id="clear-visit">Limpiar</button>
          </div>
        </div>

        <div class="panel" style="margin-top:12px">
          <h3>Historial de visitas</h3>
          <div id="visits-list"></div>
        </div>

        <div class="panel" style="margin-top:12px">
          <h3>Reportes r√°pidos</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <label class="small">Sucursal:</label>
            <select id="report-branch"></select>
            <label class="small">Especialidad:</label>
            <select id="report-specialty"></select>
            <label class="small">Desde</label>
            <input type="date" id="report-from">
            <label class="small">Hasta</label>
            <input type="date" id="report-to">
            <button class="btn-ghost" id="generate-reports">Generar</button>
          </div>

          <div class="stats" style="margin-top:8px">
            <div class="stat"><strong id="doctors-today">0</strong><div class="small">Doctores hoy</div></div>
            <div class="stat"><strong id="doctors-branches">0</strong><div class="small">Sucursales con doctores</div></div>
            <div class="stat"><strong id="multi-clinic-patients">0</strong><div class="small">Pacientes en &gt;1 cl√≠nica</div></div>
          </div>

          <div style="margin-top:10px">
            <h4 class="small">Doctores que trabajan hoy</h4>
            <div id="doctors-today-list" class="small muted"></div>
          </div>

          <div style="margin-top:10px">
            <h4 class="small">Doctores por sucursal</h4>
            <div id="doctors-by-branch-list" class="small muted"></div>
          </div>

          <div style="margin-top:10px">
            <h4 class="small">Consultas por doctor (periodo)</h4>
            <div id="consults-per-doc"></div>
          </div>

          <div style="margin-top:10px">
            <h4 class="small">Doctores ausentes esta semana</h4>
            <div id="absent-week"></div>
          </div>
        </div>

      </section>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <p>¬© <span id="year"></span> TechSide</p>
      <small class="muted">T√©rminos y condiciones ¬∑ Pol√≠tica de privacidad</small>
    </div>
  </footer>

    <script>
        (function() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user'));

            if (!token || !user) {
                window.location.href = 'formAgregar.html';
                return;
            }

            if (user.rol !== 'medico') {
                window.location.href = 'dashboard.html';
                return;
            }

            // cart count reuse
            function getCart(){ return JSON.parse(localStorage.getItem('cart')||'[]'); }
            function updateCartCount(){ const c = getCart(); const qty = c.reduce((s,i)=>s+i.qty,0); document.getElementById('cart-count').textContent = qty; }
            updateCartCount();

            function populateDoctorsSelect(){
                const sel = document.getElementById('doctor-select'); sel.innerHTML = '';
                fetch('/api/doctores', {
                    headers: { 'Authorization': `Bearer ${token}` }
                }).then(r => r.json()).then(docs => {
                    docs.forEach(d=>{ const o = document.createElement('option'); o.value=d.id; o.textContent = d.nombre + ' ‚Äî ' + d.especialidad; sel.appendChild(o); });
                });
            }
            populateDoctorsSelect();

            document.getElementById('save-pet').addEventListener('click', ()=>{
                const ruac = document.getElementById('ruac').value.trim(); if(!ruac){ alert('Clave RUAC requerida'); return; }
                const pet = {
                    ruac,
                    nombre: document.getElementById('pet-name').value,
                    tipo: document.getElementById('specie').value,
                    // ... and so on for all the fields
                };
                
                fetch('/api/mascotas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(pet)
                }).then(r => {
                    if (r.ok) alert('Ficha guardada');
                    else alert('Error guardando ficha');
                });
            });

            document.getElementById('load-pet').addEventListener('click', ()=>{
                const ruac = document.getElementById('ruac').value.trim(); if(!ruac) return alert('Indica RUAC');
                
                fetch(`/api/mascotas?ruac=${ruac}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                }).then(r => r.json()).then(pets => {
                    const p = pets[0]; if(!p) return alert('No se encontr√≥ ficha');
                    document.getElementById('pet-name').value = p.nombre||'';
                    // ... and so on for all fields
                    renderVisits(p.id);
                });
            });

            document.getElementById('save-visit').addEventListener('click', ()=>{
                const petId = document.getElementById('ruac').dataset.petId; if(!petId){ alert('Carga una mascota primero'); return; }
                const visit = {
                    mascota_id: petId,
                    medico_id: document.getElementById('doctor-select').value,
                    // ... and so on
                };

                fetch('/api/visitas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(visit)
                }).then(r => {
                    if (r.ok) {
                        alert('Visita guardada');
                        renderVisits(petId);
                    }
                    else alert('Error guardando visita');
                });
            });

            function renderVisits(petId){
                const container = document.getElementById('visits-list'); container.innerHTML='';
                fetch(`/api/mascotas/${petId}/visitas`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                }).then(r => r.json()).then(visits => {
                    if(!visits.length) container.innerHTML='<p class="muted">Sin registros</p>';
                    visits.forEach(v=>{
                        const div = document.createElement('div'); div.className='visit-item';
                        div.innerHTML = `<div class="small"><strong>${new Date(v.atendido_en).toLocaleString()}</strong> ‚Äî ${v.medico_nombre||'Doctor no asignado'}</div>
                        <div><strong>Diagn√≥stico:</strong> ${v.diagnostico}</div>`;
                        container.appendChild(div);
                    });
                });
            }
        })();
    </script>

    <div id="login-modal" class="login-modal" onclick="if(event.target===this)this.style.display='none'" style="display:none">
        <div class="login-content">
        <span class="close" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
        <form class="login-form">
            <h2>Doctor ‚Äî Iniciar sesi√≥n</h2>
            <select id="login-doctor">
            <option value="">Seleccione</option>
            </select>
            <button type="button" class="btn-primary" onclick="document.getElementById('login-modal').style.display='none'">Entrar</button>
        </form>
        </div>
    </div>
</body>
</html>
